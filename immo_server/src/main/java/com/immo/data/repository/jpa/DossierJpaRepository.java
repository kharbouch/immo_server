package com.immo.data.repository.jpa;

import java.util.List;

import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.PagingAndSortingRepository;
import org.springframework.data.repository.query.Param;
import org.springframework.scheduling.annotation.Async;

import com.immo.bean.InfoDossier;
import com.immo.bean.jpa.DossierEntity;
import com.immo.bean.jpa.RecetteEntity;
import com.immo.bean.jpa.TrancheEntity;

/**
 * Repository : Dossier.
 */
public interface DossierJpaRepository extends PagingAndSortingRepository<DossierEntity, Long> {

	@Async
    @Query("SELECT d.client.id , d.dossier.id, b.id, b.denomination, "
    		+ " d.client.nomClient, d.client.prenomClient, d.client.tel1 "
 		//+ " new list(d.client.nomClient), "
    	//	+ " new list(), "
    		+ " FROM DossierClientEntity d, BienEntity b  where b.id= d.dossier.refBien "
    		+ " and b.tranche.id = :idTranche"
    		+ " and d.dossier.etat = 'actif' ") 
    List<InfoDossier> findDossier(@Param("idTranche") Long idTranche);
	

/*	@Async
    @Query("SELECT count(r.dossier.id) as valeur "
 		//+ " new list(d.client.nomClient), "
    	//	+ " new list(), "
    		+ " FROM RecetteEntity r,  BienEntity b  where b.id= r.dossier.refBien "
    		+ " and b.tranche.id = :idTranche"
    		+ " and r.dossier.etat = 'actif' "
    		+ " and r.etat is null ") 
    long venteJournee(@Param("idTranche") Long idTranche);*/
	
	@Async
    @Query(value = "select t.val, t.descript, t.REF_PROJET from( "
    		+ "	SELECT   count(DOSSIER.ID) as val, 'VJ' as descript, DOSSIER.REF_PROJET "
+ " FROM   RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null " 
+ " AND RECETTE.DATE_DEPOT = to_date(sysdate, 'dd/mm/yyyy') "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select  count(DOSSIER.ID) as val, 'VGH' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND DOSSIER.REF_CONVENTION =25 "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select  count(DOSSIER.ID) as val, 'VGLOB' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND DOSSIER.REF_CONVENTION <>25 "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select  count(DOSSIER.ID) as val, 'VGRP' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select  nvl(sum(RECETTE.montant),0) as val, 'RJ' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null  "
+ " AND RECETTE.DATE_DEPOT = to_date(sysdate, 'dd/mm/yyyy') "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select  nvl(sum(RECETTE.montant),0) as val, 'RGH' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ "  AND DOSSIER.REF_CONVENTION = 25 " 
+ " group by DOSSIER.REF_PROJET "
+ " union " 
+ "  select  nvl(sum(RECETTE.montant),0) as val, 'RGLOB' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ "  AND DOSSIER.REF_CONVENTION <>25 " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select sum(RECETTE.montant) as val, 'RGRP' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select nvl(sum(RECETTE.montant),0) as val, 'RCVJ' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ " AND RECETTE.DATE_DEPOT = to_date(sysdate, 'dd/mm/yyyy') "
+ " AND RECETTE.DATE_DEPOT<>(select min(r.date_depot) from recette r where r.ref_dossier=RECETTE.REF_DOSSIER) "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select nvl(sum(RECETTE.montant),0) as val, 'RCVGH' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ "  AND DOSSIER.REF_CONVENTION = 25 " 
+ " AND RECETTE.DATE_DEPOT<>(select min(r.date_depot) from recette r where r.ref_dossier=RECETTE.REF_DOSSIER) "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select nvl(sum(RECETTE.montant),0) as val, 'RCVGLOB' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ "  AND DOSSIER.REF_CONVENTION <>25 " 
+ " AND RECETTE.DATE_DEPOT<>(select min(r.date_depot) from recette r where r.ref_dossier=RECETTE.REF_DOSSIER) "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ "  select nvl(sum(RECETTE.montant),0) as val, 'RCVGRP' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null " 
+ " AND RECETTE.DATE_DEPOT<>(select min(r.date_depot) from recette r where r.ref_dossier=RECETTE.REF_DOSSIER) "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select COUNT(DOSSIER.ID) as val, 'UNTVRSJ' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND RECETTE.DATE_VERSEMENT = to_date(sysdate, 'dd/mm/yyyy') " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select nvl(sum(RECETTE.montant),0) as val, 'MNTVRSJ' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND RECETTE.DATE_VERSEMENT = to_date(sysdate, 'dd/mm/yyyy') " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select COUNT(RECETTE.ID) as val, 'UNTVRS' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND RECETTE.DATE_VERSEMENT IS NOT NULL " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select nvl(sum(RECETTE.montant),0) as val, 'MNTVRS' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND RECETTE.DATE_VERSEMENT IS NOT NULL " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select COUNT(DOSSIER.ID) as val, 'UNTFACT' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND DOSSIER.DATE_FACTURATION IS NOT NULL " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select nvl(sum(RECETTE.montant),0) as val, 'MNTFACT' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " AND DOSSIER.DATE_FACTURATION IS NOT NULL " 
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select count(bien.id) as val , 'OBJV' as descript, TRANCHE.REF_PROJET "
+ " from BIEN, TRANCHE "
+ " where BIEN.REF_TRANCHE = TRANCHE.ID "
+ " group by TRANCHE.REF_PROJET "
+ " union "
+ " select nvl(sum(bien.ech_mnt_1),0) as val , 'OBJR' as descript, TRANCHE.REF_PROJET "
+ " from BIEN, TRANCHE "
+ " where BIEN.REF_TRANCHE = TRANCHE.ID "
+ " group by TRANCHE.REF_PROJET "
+ " union "
+ " select nvl(sum(nvl(bien.ech_mnt_2, 0)+nvl(bien.ech_mnt_3, 0)+nvl(bien.ech_mnt_4,0)), 0) as val , 'OBJRCV' as descript, TRANCHE.REF_PROJET "
+ " from BIEN, TRANCHE "
+ " where BIEN.REF_TRANCHE = TRANCHE.ID "
+ " group by TRANCHE.REF_PROJET "
+ " union "
+ "  select COUNT(RECETTE.ID) as val, 'OBJUNTV' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ "  WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ "  AND  DOSSIER.ETAT = 'actif' "
+ "  AND RECETTE.ETAT is null "
+ " group by DOSSIER.REF_PROJET "
+ " union "
+ " select COUNT(DOSSIER.ID) as val, 'OBJUNTFACT' as descript, DOSSIER.REF_PROJET "
+ " from RECETTE, DOSSIER "
+ " WHERE   (DOSSIER.ID = RECETTE.REF_DOSSIER) "
+ " AND  DOSSIER.ETAT = 'actif' "
+ " AND RECETTE.ETAT is null "
+ " group by DOSSIER.REF_PROJET "
+ " ) t ", nativeQuery = true) 
    List<Object> venteJournee();
}



